- name: Use rate-mirrors if available
  when: pacman_rate_mirrors
  ansible.builtin.include_tasks: rate_mirrors.yml

- name: Upgrade packages
  become: true
  community.general.pacman:
    update_cache: true
    upgrade: true
  register: pacman_result
  # According to
  #     https://docs.ansible.com/projects/ansible/latest/collections/community/general/pacman_module.html
  # this module now reports 'changed' even if only the cache was updated, with
  # no upgrades; this is the workaround.
  changed_when: pacman_result.packages is defined and (pacman_result.packages | length > 0)
  notify: pacman_upgraded

- name: Reboot if necessary
  ansible.builtin.meta: flush_handlers

- name: Install packages
  become: true
  ansible.builtin.package:
    name: '{{ pacman_packages }}'
    state: present
    reason: explicit
    reason_for: all
  when: pacman_packages | length > 0
  register: pacman_result

- name: Show installed packages
  ansible.builtin.debug:
    var: pacman_result.packages
  when: pacman_result.packages is defined and (pacman_result.packages | length > 0)

- name: Get list of unneeded dependencies
  ansible.builtin.command: pacman -Qqdt
  register: pacman_result
  changed_when: false
  failed_when: |
    pacman_result.rc != 0
    and not (pacman_result.rc == 1 and (pacman_result.stdout_lines | length == 0))

- name: Remove unneeded dependencies
  become: true
  community.general.pacman:
    name: '{{ pacman_result.stdout_lines }}'
    state: absent
    extra_args: --recursive
    remove_nosave: true
  when: pacman_result.stdout_lines | length > 0
  register: pacman_result

- name: Show removed packages
  ansible.builtin.debug:
    var: pacman_result.packages
  when: pacman_result.packages is defined
