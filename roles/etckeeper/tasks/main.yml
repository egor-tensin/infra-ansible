- name: Check if /etc is versioned
  become: true
  ansible.builtin.file:
    path: /etc/.git/config
    state: file
  register: etc_versioned
  ignore_errors: true

- when: etc_versioned
  block:
    - name: Check etckeeper is available
      ansible.builtin.command: etckeeper --version
      register: etckeeper_installed
      changed_when: false
      failed_when: false

    - name: Fail if /etc is versioned, but not by etckeeper
      ansible.builtin.fail:
        msg: /etc is versioned, but etckeeper doesn't seem to be installed.
      when: not etckeeper_installed

    - name: Configure /etc repository
      become: true
      community.general.git_config:
        scope: local
        repo: /etc
        name: '{{ item.name }}'
        value: '{{ item.value }}'
      loop:
        - name: user.name
          value: '{{ git_name }}'
        - name: user.email
          value: '{{ git_email }}'
